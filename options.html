<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI 摘要阅读器 - 设置</title>
  <link rel="stylesheet" href="options.css" />
  <!-- 提前定义 SXUI（移除内联脚本，改为外链以符合 MV3 CSP） -->
  <script src="options.preload.js" defer></script>
  <script src="vendor/petite-vue.iife.js" defer></script>
</head>
<body>
  <!-- 顶部抬头区 -->
  <header class="hero">
    <div class="wrap">
      <div class="hero-header">
        <h1 class="hero-title">
          <span id="settings-title">麦乐可 AI 摘要阅读器 · 设置</span>
          <span class="badge" id="app-version"></span>
        </h1>
        <div class="language-switcher">
          <button id="lang-zh" class="lang-btn active" data-lang="zh">中文</button>
          <button id="lang-en" class="lang-btn" data-lang="en">English</button>
        </div>
      </div>
      <p class="hero-sub" id="settings-subtitle">配置 API / 模型 / 输出语言与 System Prompt 预设；底部有统一的"保存全部设置"。</p>
    </div>
  </header>

  <main class="wrap main-with-dock">
    
    <!-- 基础配置 -->
    <section class="section card">
      <h2 class="section-title"><span class="dot"></span> <span id="basic-config">基础配置</span></h2>
      <div class="field field-full" id="sx-ui-scope" v-scope="{ ui: window.SXUI }">
        <label class="label" for="aiProvider">
          <!-- 图标 -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              width="18" height="18" style="vertical-align: middle; margin-right:6px;">
            <defs>
              <linearGradient id="gradBrain" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#4facfe"/>
                <stop offset="100%" stop-color="#00f2fe"/>
              </linearGradient>
            </defs>
            <path fill="url(#gradBrain)" d="M12 2a6 6 0 00-6 6v1a6 6 0 00-6 6c0 3.3 2.7 6 6 6h1a6 6 0 0011 0h1a6 6 0 006-6 6 6 0 00-6-6V8a6 6 0 00-6-6z"/>
          </svg>
          <span id="ai-platform">AI 平台</span>
        </label>
        <select id="aiProvider" class="ctrl" :class="{ 'ctrl-focus': ui.focus.aiProvider }" @focus="ui.focus.aiProvider=true" @blur="ui.focus.aiProvider=false">
          <option value="trial" id="trial-option">试用（推荐体验）</option> <!-- ← 新增这一行放最上，UI 默认显示它 -->
          <option value="openai" id="openai-option">OpenAI（默认）</option>
          <option value="deepseek" id="deepseek-option">DeepSeek</option>
          <option value="custom" id="custom-option">自定义</option>
        </select>
        <!-- 购买指南（紧跟在下拉框后，右侧留白展示） -->
        <span class="buy-help-inline">
          <span id="buy-help-text">不会买？查看：</span>
          <a id="link-buy-openai" href="#" target="_blank" rel="noopener">OpenAI 指南</a>
          <span id="buy-help-sep"> · </span>
          <a id="link-buy-deepseek" href="#" target="_blank" rel="noopener">DeepSeek 指南</a>
        </span>
        <!-- Trial consent (only visible in trial mode) -->
        <div class="field" id="trial-consent-wrap" style="margin-top:8px;">
          <div class="help" id="trial-consent-help">
            <label style="display:flex; align-items:center; gap:8px;">
              <input id="trial_consent" type="checkbox" />
              <span id="trial-consent-text">我已阅读并同意：试用模式会通过代理服务器传输页面内容，用于生成摘要/清洗正文。</span>
            </label>
          </div>
        </div>
        <p class="hint" id="platform-hint">切换平台将自动填写 Base URL 和模型；若手动修改任意字段，将自动切到「自定义」。</p>
      </div>

      <div class="grid" v-scope="{ ui: window.SXUI }">
        <div class="field">
          <label class="label" id="api-key-label">OpenAI API Key</label>
          <div class="eye-wrap">
            <input id="apiKey" class="ctrl" type="password" placeholder="sk-..."
              :class="{ 'ctrl-focus': ui.focus.apiKey }"
              @focus="ui.focus.apiKey = true" @blur="ui.focus.apiKey = false" />
            <button id="toggleKey" class="eye-btn" type="button" aria-label="显示/隐藏">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- 给 BaseURL 外层一个可控的 ID，便于 Trial 时整体隐藏 -->
        <div class="field" id="field-baseURL">
          <label class="label" id="base-url-label">Base URL</label>
          <input id="baseURL" class="ctrl" placeholder="https://api.openai.com/v1"
            :class="{ 'ctrl-focus': ui.focus.baseURL }"
            @focus="ui.focus.baseURL = true" @blur="ui.focus.baseURL = false" />
        </div>

        <div class="field">
          <label class="label" id="extract-model-label">清洗模型（extract）</label>
          <input id="model_extract" class="ctrl" placeholder="gpt-4o-mini"
            :class="{ 'ctrl-focus': ui.focus.model_extract }"
            @focus="ui.focus.model_extract = true" @blur="ui.focus.model_extract = false" />
        </div>

        <div class="field">
          <label class="label" id="summarize-model-label">摘要/翻译模型（summarize）</label>
          <input id="model_summarize" class="ctrl" placeholder="gpt-4o-mini"
            :class="{ 'ctrl-focus': ui.focus.model_summarize }"
            @focus="ui.focus.model_summarize = true" @blur="ui.focus.model_summarize = false" />
        </div>

        <div class="field">
          <label class="label" id="output-lang-label">输出语言（Output Language）</label>
          <select id="output_lang" class="ctrl" :class="{ 'ctrl-focus': ui.focus.output_lang }" @focus="ui.focus.output_lang=true" @blur="ui.focus.output_lang=false">
            <option value="" id="auto-option">自动（Auto）</option>
            <option value="zh" id="chinese-option">中文（Chinese）</option>
            <option value="en" id="english-option">English（英文）</option>
          </select>
        </div>

        <div class="field">
          <label class="label" id="extract-mode-label">正文提取方式（Extract Mode）</label>
          <select id="extract_mode" class="ctrl" :class="{ 'ctrl-focus': ui.focus.extract_mode }" @focus="ui.focus.extract_mode=true" @blur="ui.focus.extract_mode=false">
            <option value="fast" id="fast-option">本地快速（推荐）</option>
            <option value="ai" id="ai-option">AI 清洗</option>
          </select>
        </div>
      </div>
    </section>

    <!-- 广告过滤 -->
    <section class="section card">
      <h2 class="section-title"><span class="dot"></span> 广告过滤</h2>
      <div class="adblock-row">
        <div class="field">
          <label class="label">启用广告过滤</label>
          <div class="row" style="display:flex; align-items:center; gap:12px;">
            <label class="switch">
              <input id="adblock_enabled" type="checkbox" />
              <span class="switch-slider"></span>
            </label>
            <span class="hint">打开后自动下载所选规则</span>
          </div>
        </div>
        <div class="field">
          <label class="label">弹窗拦截</label>
          <div class="row" style="display:flex; align-items:center; gap:12px;">
            <label class="switch">
              <input id="adblock_block_popups" type="checkbox" />
              <span class="switch-slider"></span>
            </label>
            <span class="hint">阻止“/pop?url=…”等骚扰弹窗</span>
          </div>
        </div>

        <div class="field">
          <label class="label">过滤强度</label>
          <div class="seg" id="adblock-strength-seg" role="tablist" aria-label="过滤强度">
            <button class="seg-btn" data-strength="low" aria-selected="false">低</button>
            <button class="seg-btn" data-strength="medium" aria-selected="true">中</button>
            <button class="seg-btn" data-strength="high" aria-selected="false">高</button>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label">全球性广告过滤列表
          <button id="sync_all_global" class="sync-all-btn" type="button" title="全部更新" aria-label="全部更新" data-tip="全部更新">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 2v6h-6"/><path d="M3 22v-6h6"/><path d="M21 8a9 9 0 0 0-15.5-6.36L3 6"/><path d="M3 16a9 9 0 0 0 15.5 6.36L21 18"/>
            </svg>
          </button>
          <span id="adblock_global_summary_inline" class="adbl-summary-inline" aria-live="polite"></span>
        </label>
        <div id="adblock_global_lists" class="checklist"></div>
      </div>

      <div class="field">
        <label class="label">区域性广告过滤列表
          <button id="sync_all_regional" class="sync-all-btn" type="button" title="全部更新" aria-label="全部更新" data-tip="全部更新">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 2v6h-6"/><path d="M3 22v-6h6"/><path d="M21 8a9 9 0 0 0-15.5-6.36L3 6"/><path d="M3 16a9 9 0 0 0 15.5 6.36L21 18"/>
            </svg>
          </button>
          <span id="adblock_regional_summary_inline" class="adbl-summary-inline" aria-live="polite"></span>
        </label>
        <div id="adblock_regional_lists" class="checklist"></div>
      </div>

      <p class="hint">提示：选择后将在后台自动下载并保存在本地，仅用于本扩展的广告过滤功能。</p>
    </section>

    <!-- System Prompt -->
    <section class="section card note">
      <h2 class="section-title"><span class="dot"></span> <span id="system-prompt-title">System Prompt（系统提示词）</span></h2>

      <div class="grid">
        <div class="field">
          <label class="label" id="presets-label">选择预设（Presets）</label>
          <select id="system_prompt_preset" class="ctrl">
            <option value="general_summary" id="general-summary-option">General summarization</option>
            <option value="faithful_translation" id="faithful-translation-option">Faithful translation</option>
            <option value="tech_article_translation" id="tech-article-translation-option">Tech article translation</option>
          </select>
        </div>

        <div class="field">
          <div class="help" id="preset-hint">
            说明：可选预设为英文描述；你也可以在下面输入自定义提示词。<br/>
            无论选择哪种提示词，系统都会强制追加一句"请将结果输出为目标语言"（根据"输出语言"或自动识别）。
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label" id="custom-prompt-label">自定义系统提示词（可留空）</label>
        <textarea id="system_prompt_custom" class="ctrl mono" placeholder="例如：Be concise and faithful. Keep structure and factual accuracy."></textarea>
      </div>
    </section>

    <!-- 快捷键设置（内容最后一栏） -->
    <section class="section card shortcut">
      <h2 class="section-title"><span class="dot"></span> <span id="shortcuts-title">快捷键设置</span></h2>
      <p class="shortcut-desc" id="shortcut-desc">你可以在 Chrome 的扩展快捷键页面里绑定快捷键，用于快速打开侧边栏。</p>
      <div class="row btns">
        <button id="open-shortcut" class="btn">去设置快捷键</button>
        <span class="hint" id="shortcut-hint">前往 <code>chrome://extensions/shortcuts</code>，搜索"麦乐可AI摘要阅读器"，给命令 <code>打开/切换侧边栏</code> 绑定组合键。</span>
      </div>
    </section>
  </main>

  <!-- 新增：底部占位，避免被固定保存栏遮挡 -->
  <div id="dock-spacer" aria-hidden="true"></div>

  <!-- 固定底栏：全局统一保存 -->
  <aside class="save-dock">
    <div class="dock-inner wrap">
      <div class="dock-left">
        <div class="status-line">
          <span class="status-dot" id="status-dot"></span>
          <span id="status" class="status-text">就绪</span>
        </div>
        <div id="meta" class="meta"></div>
      </div>
      <div class="dock-right">
        <!-- 外观切换：与浮窗一致的三态（自动/浅色/深色） -->
        <div class="theme-toggle" id="opt-theme" title="外观">
          <span class="label" id="appearance-label">外观</span>
          <div class="seg" role="tablist" aria-label="外观切换">
            <!-- 自动：A 字母图标 -->
            <button class="theme-btn" data-mode="auto" role="tab" aria-selected="true" title="自动">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" fill="currentColor" opacity=".12"/>
                <text x="12" y="15" text-anchor="middle" font-size="12" font-family="ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" fill="currentColor">A</text>
              </svg>
            </button>
            <!-- 浅色：太阳图标 -->
            <button class="theme-btn" data-mode="light" role="tab" aria-selected="false" title="浅色">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="4" fill="currentColor"/>
                <g stroke="currentColor" stroke-width="2" stroke-linecap="round">
                  <line x1="12" y1="1" x2="12" y2="4"/>
                  <line x1="12" y1="20" x2="12" y2="23"/>
                  <line x1="1" y1="12" x2="4" y2="12"/>
                  <line x1="20" y1="12" x2="23" y2="12"/>
                  <line x1="4.2" y1="4.2" x2="6.3" y2="6.3"/>
                  <line x1="17.7" y1="17.7" x2="19.8" y2="19.8"/>
                  <line x1="17.7" y1="6.3" x2="19.8" y2="4.2"/>
                  <line x1="4.2" y1="19.8" x2="6.3" y2="17.7"/>
                </g>
              </svg>
            </button>
            <!-- 深色：月牙图标 -->
            <button class="theme-btn" data-mode="dark" role="tab" aria-selected="false" title="深色">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M21 12.8A8.5 8.5 0 0 1 11.2 3a.6.6 0 0 0-.8.7 7.1 7.1 0 0 0 9.7 9.7.6.6 0 0 0 .9-.6Z"/>
              </svg>
            </button>
          </div>
        </div>
        <button id="btn-test" class="btn">测试 API Key</button>
        <button id="btn-save" class="btn primary">保存全部设置</button>
      </div>
    </div>
  </aside>

  <script type="module" src="options.js"></script>
  <script type="module" src="options.pv.js"></script>
  <script type="module" src="options.app.js"></script>

  <!-- Toast 容器：不改变布局，绝对定位到右下角 -->
  <div id="sx-toast-root" v-scope aria-live="polite" aria-atomic="true">
    <div class="sx-toast" :class="t.type" v-for="t in toasts" @click="removeToast(t.id)">{{ t.msg }}</div>
  </div>
</body>
</html>
